name: Jekyll site CI

# 触发条件
on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

# 设置权限
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    # 添加并发限制，防止同时运行多个相同的工作流
    concurrency:
      group: pages-${{ github.workflow }}
      cancel-in-progress: true
      
    steps:
    - uses: actions/checkout@v4

    - name: 设置 Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: 设置页面缓存
      uses: actions/configure-pages@v3
    
    - name: 安装依赖
      run: bundle install
    
    - name: 验证 Secrets
      run: |
        if [ -n "${{ secrets.GOOGLE_ANALYTICS_ID }}" ]; then
          echo "✓ GOOGLE_ANALYTICS_ID is set"
        else
          echo "✗ GOOGLE_ANALYTICS_ID is not set"
        fi
        if [ -n "${{ secrets.GITALK_CLIENT_ID }}" ]; then
          echo "✓ GITALK_CLIENT_ID is set"
        else
          echo "✗ GITALK_CLIENT_ID is not set"
        fi
        if [ -n "${{ secrets.GITALK_CLIENT_SECRET }}" ]; then
          echo "✓ GITALK_CLIENT_SECRET is set"
        else
          echo "✗ GITALK_CLIENT_SECRET is not set"
        fi

    - name: 创建密钥配置
      env:
        JEKYLL_ENV: production
      run: |
        echo "# Auto-generated secrets configuration" > _config_secrets.yml
        echo "google_analytics: '${{ secrets.GOOGLE_ANALYTICS_ID }}'" >> _config_secrets.yml
        echo "gitalk:" >> _config_secrets.yml
        echo "  clientID: '${{ secrets.GITALK_CLIENT_ID }}'" >> _config_secrets.yml
        echo "  clientSecret: '${{ secrets.GITALK_CLIENT_SECRET }}'" >> _config_secrets.yml
        
        # 验证配置文件是否正确生成（不显示实际值）
        echo "Verifying _config_secrets.yml structure:"
        cat _config_secrets.yml | grep -v "clientID\|clientSecret\|google_analytics"

    - name: 构建站点
      env:
        JEKYLL_ENV: production
      run: |
        # 验证配置是否被正确合并
        echo "Verifying Jekyll configuration..."
        bundle exec jekyll build --config _config.yml,_config_secrets.yml --trace || {
          echo "构建失败，检查合并后的配置（不显示敏感值）"
          bundle exec jekyll build --config _config.yml,_config_secrets.yml --trace --verbose | grep -v "clientID\|clientSecret\|google_analytics"
          exit 1
        }
    
    - name: 上传构建产物
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site

    - name: 清理缓存
      run: bundle clean --force
      if: always()  # 即使前面步骤失败也执行

    # 部署到 GitHub Pages
    - name: 部署到 GitHub Pages
      id: deployment  # 添加 id 以便引用输出
      if: github.ref == 'refs/heads/main'
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        timeout: 600000  # 10分钟超时
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}